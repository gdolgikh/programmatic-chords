---
import Layout from '../components/Layout.astro';
import ChordDiagram from '../components/ChordDiagram.astro';
import { chords } from '../data/chords.js';

export function getStaticPaths() {
  return chords.map(chord => ({
    params: { slug: chord.slug },
    props: { chord },
  }));
}

const { chord } = Astro.props;

// Find prev/next chords
const idx = chords.findIndex(c => c.slug === chord.slug);
const prev = idx > 0 ? chords[idx - 1] : null;
const next = idx < chords.length - 1 ? chords[idx + 1] : null;

// String labels
const stringNames = ['E', 'A', 'D', 'G', 'B', 'e'];

// Get MIDI data safely - handle missing or incomplete data
const getMidiData = () => {
  if (!chord.allPositions?.[0]?.midi) {
    return [];
  }
  const midi = chord.allPositions[0].midi;
  // Create a full array mapping to frets, with null for muted strings
  const fullMidi = [];
  let midiIndex = 0;
  for (let i = 0; i < chord.frets.length; i++) {
    if (chord.frets[i] === -1) {
      fullMidi[i] = null; // Muted string
    } else if (midiIndex < midi.length) {
      fullMidi[i] = midi[midiIndex];
      midiIndex++;
    }
  }
  return fullMidi;
};

const chordMidi = getMidiData();

// Build notes-on-strings info
const fretLabel = (f) => {
  if (f === -1) return '×';
  if (f === 0) return 'Open';
  return `Fret ${f}`;
};
---

<Layout title={`${chord.name} — ChordLab`}>
  <script>
    // Audio playback implementation
    let Tone;
    let sampler;
    let isLoading = false;
    let isLoaded = false;

    const playButton = document.getElementById('play-chord-btn');
    const statusDiv = document.getElementById('audio-status');
    const diagram = document.getElementById('chord-diagram');

    // Get MIDI data from SVG
    const chordMidi = JSON.parse(diagram?.getAttribute('data-midi') || '[]');

    // Convert MIDI number to note name for Tone.js
    function midiToNoteName(midi) {
      const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const octave = Math.floor(midi / 12) - 1;
      const noteIndex = midi % 12;
      return noteNames[noteIndex] + octave;
    }

    // Lazy load Tone.js on first interaction
    async function initAudio() {
      if (isLoaded) return;
      if (isLoading) return;

      isLoading = true;

      playButton.disabled = true;
      playButton.classList.add('loading');

      const playText = playButton.querySelector('.play-text');
      const originalText = playText.textContent;
      playText.textContent = 'Loading...';

      statusDiv.textContent = 'Loading guitar sounds...';

      try {
        // Dynamic import of Tone.js from CDN
        const ToneModule = await import('tone');
        Tone = ToneModule.default || ToneModule;

        // Start Tone.js audio context first
        await Tone.start();

        // Create sampler with acoustic guitar samples (same as ProgChord app)
        sampler = new Tone.Sampler({
          urls: {
            A2: 'A2.mp3', C3: 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3',
            A3: 'A3.mp3', C4: 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3',
            A4: 'A4.mp3', C5: 'C5.mp3',
          },
          baseUrl: 'https://cdn.jsdelivr.net/gh/nbrosowsky/tonejs-instruments/samples/guitar-acoustic/',
          release: 1.5,
          onload: () => {
            isLoaded = true;
            isLoading = false;
            playButton.disabled = false;
            playButton.classList.remove('loading');
            playText.textContent = originalText;
            statusDiv.textContent = 'Ready to play!';
            setTimeout(() => statusDiv.textContent = '', 2000);
          },
          onerror: () => {
            console.warn('Sample loading failed, audio may not work');
            isLoaded = true;
            isLoading = false;
            playButton.disabled = false;
            playButton.classList.remove('loading');
            playText.textContent = originalText;
            statusDiv.textContent = 'Audio unavailable';
          },
        }).toDestination();
        sampler.volume.value = -6;

      } catch (error) {
        console.error('Failed to load audio:', error);
        statusDiv.textContent = 'Audio load failed';
        playButton.disabled = false;
        playButton.classList.remove('loading');
        const playText = playButton.querySelector('.play-text');
        playText.textContent = 'Play';
        isLoading = false;
      }
    }

    // Play full chord with strum
    async function playChord() {
      if (!isLoaded) {
        await initAudio();
        return;
      }

      const now = Tone.now();
      const strumDelay = 0.018; // 18ms between strings for natural strum

      // Filter out null values (muted strings) and play only valid MIDI notes
      chordMidi.forEach((midi, index) => {
        if (midi !== null && midi !== undefined) {
          const noteName = midiToNoteName(midi);
          const time = now + (index * strumDelay);
          sampler.triggerAttackRelease(noteName, '2n', time);
        }
      });

      // Visual feedback
      playButton.classList.add('playing');
      setTimeout(() => playButton.classList.remove('playing'), 500);
    }

    // Play single note when dot clicked
    async function playNote(midi) {
      if (!isLoaded) {
        await initAudio();
        if (isLoaded) {
          playNote(midi);
        }
        return;
      }

      const noteName = midiToNoteName(midi);
      sampler.triggerAttackRelease(noteName, '2n');
    }

    // Attach event listeners
    if (playButton) {
      playButton.addEventListener('click', playChord);
      playButton.addEventListener('mouseenter', initAudio, { once: true });
    }

    // Add click handlers to finger dots
    document.querySelectorAll('.finger-dot').forEach(dot => {
      dot.addEventListener('click', (e) => {
        e.stopPropagation();
        const midi = parseInt(dot.getAttribute('data-midi'));
        if (midi) {
          playNote(midi);

          // Visual feedback on dot
          dot.style.filter = 'brightness(1.5)';
          setTimeout(() => dot.style.filter = '', 200);
        }
      });
    });
  </script>

  <article class="chord-page">
    <div class="chord-hero glass">
      <div class="chord-diagram-wrap glass">
        <div class="chord-diagram-container">
          <ChordDiagram
            frets={chord.frets}
            fingers={chord.fingers}
            barres={chord.barres}
            midi={chordMidi}
            size="large"
          />

          <button id="play-chord-btn" class="play-button" aria-label="Play chord">
            <svg class="play-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <span class="play-text">Play</span>
          </button>

          <div id="audio-status" class="audio-status" aria-live="polite"></div>
        </div>
      </div>

      <div class="chord-info">
        <div class="chord-badge">{chord.quality}</div>
        <h1 class="chord-name">{chord.name}</h1>
        <p class="chord-desc">{chord.description}</p>

        <div class="chord-frets">
          <h3 class="detail-heading">String by String</h3>
          <div class="fret-list">
            {chord.frets.map((f, i) => (
              <div class:list={['fret-item', { muted: f === -1 }]}>
                <span class="fret-string">{stringNames[i]}</span>
                <span class="fret-value">{fretLabel(f)}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>

    <nav class="chord-nav">
      {prev ? (
        <a href={`/${prev.slug}/`} class="nav-btn glass">
          <span class="nav-arrow">&larr;</span>
          <span class="nav-label">{prev.name}</span>
        </a>
      ) : <div />}
      <a href="/" class="nav-btn glass nav-home">All Chords</a>
      {next ? (
        <a href={`/${next.slug}/`} class="nav-btn glass">
          <span class="nav-label">{next.name}</span>
          <span class="nav-arrow">&rarr;</span>
        </a>
      ) : <div />}
    </nav>
  </article>
</Layout>

<style>
  .chord-page {
    padding-top: 1rem;
  }

  .chord-hero {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 2.5rem;
    padding: 2.5rem;
    align-items: start;
  }

  .chord-diagram-wrap {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 1.5rem;
  }

  .chord-diagram-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .play-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #0891b2, #06b6d4);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
    max-width: 260px;
    justify-content: center;
  }

  .play-button:hover {
    background: linear-gradient(135deg, #0e7490, #0891b2);
    transform: translateY(-1px);
  }

  .play-button:active {
    transform: translateY(0);
  }

  .play-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .play-button.loading {
    pointer-events: none;
  }

  .play-button.loading .play-icon {
    animation: spin 1s linear infinite;
  }

  .play-button.loading .play-text {
    opacity: 0.7;
  }

  .play-button.playing {
    background: linear-gradient(135deg, #14b8a6, #0d9488);
  }

  .audio-status {
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
    min-height: 1.2em;
    width: 100%;
    max-width: 260px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .play-icon {
    transition: transform 0.3s ease;
  }

  .chord-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .chord-badge {
    align-self: flex-start;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #67e8f9;
    background: rgba(6, 182, 212, 0.15);
    padding: 0.3rem 0.8rem;
    border-radius: 8px;
  }

  .chord-name {
    font-size: clamp(2rem, 4vw, 2.8rem);
    font-weight: 800;
    letter-spacing: -0.02em;
    line-height: 1.15;
  }

  .chord-desc {
    font-size: 1.05rem;
    line-height: 1.7;
    color: rgba(255, 255, 255, 0.6);
    max-width: 520px;
  }

  .detail-heading {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255, 255, 255, 0.4);
    margin-top: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .fret-list {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .fret-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    padding: 0.4rem 0.6rem;
    background: rgba(255, 255, 255, 0.04);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.06);
    min-width: 52px;
  }

  .fret-item.muted {
    opacity: 0.4;
  }

  .fret-string {
    font-size: 0.75rem;
    font-weight: 700;
    color: #67e8f9;
  }

  .fret-value {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
  }

  .chord-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    gap: 1rem;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    font-size: 0.9rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    text-decoration: none;
  }

  .nav-btn:hover {
    color: white;
  }

  .nav-arrow {
    font-size: 1.1rem;
  }

  .nav-home {
    color: rgba(103, 232, 249, 0.8);
  }

  /* Mobile */
  @media (max-width: 768px) {
    .chord-hero {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      padding: 1.5rem;
    }

    .chord-diagram-wrap {
      justify-self: center;
    }

    .chord-nav {
      flex-direction: column;
    }

    .nav-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
